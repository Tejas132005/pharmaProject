{% extends 'core/base.html' %}
{% load core_tags %}
{% block title %}Assessment Results - PharmaGuard{% endblock %}
{% block extra_css %}
<style>
    .risk-card {
        border-radius: 16px;
        margin-bottom: 2rem;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.05);
        background: white;
    }

    .risk-header {
        padding: 1.5rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8fafc;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .risk-badge {
        padding: 0.5rem 1.2rem;
        border-radius: 8px;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.85rem;
    }

    .risk-Safe {
        background: #d1fae5;
        color: #065f46;
    }

    .risk-Toxic {
        background: #fee2e2;
        color: #991b1b;
    }

    .risk-Ineffective {
        background: #f3e8ff;
        color: #6b21a8;
    }

    .risk-Unknown {
        background: #e2e8f0;
        color: #475569;
    }

    .risk-AdjustDosage {
        background: #fef3c7;
        color: #92400e;
    }

    .explanation-section {
        padding: 2rem;
    }

    .explanation-title {
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 1rem;
        color: var(--primary);
    }

    .json-preview {
        background: #1e293b;
        color: #e2e8f0;
        padding: 1.5rem;
        border-radius: 12px;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
</style>
{% endblock %}
{% block content %}
<div class="animate-fade-in">
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="h3 mb-1">Clinical Assessment Report</h1>
            <p class="text-muted">Patient ID: {{ patient.patient_id }}</p>
        </div>
        <div>
            <a href="{% url 'landing' %}" class="btn btn-outline-secondary">New Assessment</a>
        </div>
    </div>
    {% for a in assessments %}
    <div class="risk-card shadow-sm">
        <div class="risk-header">
            <div>
                <h4 class="mb-0">{{ a.drug_name }}</h4>
                <small class="text-muted">Gene: {{ a.gene_name }}</small>
            </div>
            <div class="d-flex align-items-center gap-3">
                <span class="risk-badge risk-{{ a.risk_css }}">{{ a.risk_label }}</span>
                <button class="btn btn-dark btn-sm" onclick="exportJSON({{ a.id }})">Download JSON</button>
            </div>
        </div>
        <div class="explanation-section">
            <div class="row">
                <div class="col-lg-8">
                    <div class="mb-4">
                        <div class="explanation-title">Review Summary</div>
                        <p>{{ a.summary }}</p>
                    </div>
                    <div class="mb-4">
                        <div class="explanation-title">Clinical Recommendation</div>
                        <div
                            class="alert {% if a.risk_label == 'Safe' %}alert-success{% elif a.risk_label == 'Toxic' %}alert-danger{% else %}alert-warning{% endif %}">
                            <strong>Action:</strong> {{ a.action }}
                        </div>
                    </div>
                    <div class="accordion" id="acc{{ a.id }}">
                        <div class="accordion-item border-0 mb-3">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed rounded" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#bio{{ a.id }}">Biological
                                    Mechanism</button>
                            </h2>
                            <div id="bio{{ a.id }}" class="accordion-collapse collapse" data-bs-parent="#acc{{ a.id }}">
                                <div class="accordion-body text-muted">{{ a.mechanism }}</div>
                            </div>
                        </div>
                        <div class="accordion-item border-0">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed rounded" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#ev{{ a.id }}">Genetic Evidence</button>
                            </h2>
                            <div id="ev{{ a.id }}" class="accordion-collapse collapse" data-bs-parent="#acc{{ a.id }}">
                                <div class="accordion-body">
                                    {{ a.variant_table|safe }}
                                    <p class="small text-muted mt-2">{{ a.evidence }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="explanation-title">JSON Output</div>
                    <div class="position-relative">
                        <pre class="json-preview" id="j{{ a.id }}">{{ a.json_pretty }}</pre>
                        <button class="btn btn-sm btn-light position-absolute top-0 end-0 m-2"
                            onclick="copyJSON('j{{ a.id }}')">Copy</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}
{% block extra_js %}
<script>
    function copyJSON(id) {
        var el = document.getElementById(id);
        navigator.clipboard.writeText(el.textContent).then(function () {
            alert('JSON copied to clipboard!');
        });
    }
    function exportJSON(id) {
        fetch('/api/assessment/' + id + '/')
            .then(function (r) { return r.json(); })
            .then(function (data) {
                var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'assessment_' + id + '.json';
                a.click();
            });
    }
</script>
{% endblock %}